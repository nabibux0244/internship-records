<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Internship Records</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: auto; }
  input, button { padding: 10px; margin: 5px 0; width: 100%; max-width: 400px; }
  .card { border: 1px solid #ccc; border-radius: 8px; padding: 15px; margin-bottom: 10px; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

<h2>Internship Records</h2>

<input type="file" id="fileInput" accept=".xlsx,.xls">
<input type="text" id="searchInput" placeholder="Search by name, phone, email, role">
<button id="searchBtn">Search</button>
<div id="records"></div>

<script>
let allRecords = [];

document.getElementById('fileInput').addEventListener('change', handleFile);
document.getElementById('searchBtn').addEventListener('click', searchRecords);
window.addEventListener('load', fetchRecords);

async function handleFile(e) {
  const file = e.target.files[0];
  const reader = new FileReader();
  reader.onload = async (evt) => {
    const arrayBuffer = evt.target.result;

    // Upload to Vercel Blob API
    await fetch('/api/upload', {
      method: 'POST',
      headers: { 'Content-Type': 'application/octet-stream' },
      body: arrayBuffer
    });

    fetchRecords();
  };
  reader.readAsArrayBuffer(file);
}

async function fetchRecords() {
  const res = await fetch('/api/upload', { method: 'GET' });
  const files = await res.json();
  const records = [];

  for (const f of files) {
    const r = await fetch(f.url);
    const arrayBuffer = await r.arrayBuffer();
    const wb = XLSX.read(arrayBuffer, { type: 'array' });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    records.push(...XLSX.utils.sheet_to_json(sheet));
  }

  allRecords = records;
  displayRecords(allRecords);
}

function displayRecords(records) {
  const container = document.getElementById('records');
  container.innerHTML = '';
  records.forEach(rec => {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <strong>${rec['Full Name'] || 'Candidate'}</strong><br>
      Phone: ${rec['Phone'] || ''}<br>
      Email: ${rec['Email'] || ''}<br>
      Role: ${rec['Role'] || ''}
    `;
    container.appendChild(card);
  });
}

function searchRecords() {
  const query = document.getElementById('searchInput').value.toLowerCase();
  const filtered = allRecords.filter(rec =>
    Object.values(rec).some(val => val?.toString().toLowerCase().includes(query))
  );
  displayRecords(filtered);
}
</script>

</body>
</html>
